<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Reino da Barba</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Custom CSS for Barbershop Theme -->
    <style>
        :root {
            --primary-bg: #1a1a1a; /* Dark background */
            --secondary-bg: #2a2a2a; /* Slightly lighter dark for cards */
            --text-color: #f8f9fa; /* Light text */
            --accent-color: #d4af37; /* Gold accent */
            --border-color: #444;
            --table-header-bg: #3a3a3a;
            --table-row-bg: #2a2a2a;
            --table-text-color: #f8f9fa; /* Default for dark theme */
            --table-text-dark-readable: #333; /* For specific table cells */
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .navbar {
            background-color: var(--secondary-bg) !important;
            border-bottom: 1px solid var(--border-color);
        }
        .navbar-brand {
            color: var(--accent-color) !important;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .container-fluid {
            padding: 20px;
        }

        .card {
            background-color: var(--secondary-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: var(--table-header-bg);
            border-bottom: 1px solid var(--border-color);
            color: var(--accent-color);
            font-weight: bold;
            padding: 10px 15px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .card-body {
            padding: 15px;
        }

        .kpi-card {
            text-align: center;
            padding: 15px;
            border-left: 3px solid var(--accent-color);
            height: 100%; /* Ensure all KPI cards have same height */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .kpi-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 5px;
            line-height: 1.2;
        }
        .kpi-label {
            font-size: 0.9rem;
            color: #bbb;
            text-transform: uppercase;
        }

        .form-control, .form-select {
            background-color: var(--primary-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--primary-bg);
            color: var(--text-color);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25);
        }
        .form-label {
            color: var(--text-color);
        }

        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--primary-bg);
            font-weight: bold;
        }
        .btn-primary:hover {
            background-color: #c0a030;
            border-color: #c0a030;
        }
        .btn-secondary {
            background-color: #555;
            border-color: #555;
            color: var(--text-color);
        }
        .btn-secondary:hover {
            background-color: #666;
            border-color: #666;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        .table {
            color: var(--table-text-color);
        }
        .table th {
            background-color: var(--table-header-bg);
            color: var(--accent-color);
            border-color: var(--border-color);
        }
        .table td {
            background-color: var(--table-row-bg);
            border-color: var(--border-color);
        }
        /* Specific style for table text readability as requested */
        #monthlySummaryTable tbody td {
            color: var(--table-text-dark-readable); /* Dark text */
            background-color: #f0f0f0; /* Light background for contrast */
        }
        #monthlySummaryTable tbody tr:nth-child(even) td {
            background-color: #e0e0e0; /* Slightly darker for even rows */
        }
        #monthlySummaryTable thead th {
            color: var(--accent-color);
            background-color: var(--table-header-bg);
        }


        .alert {
            margin-top: 15px;
        }

        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for charts */
            width: 100%;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .kpi-value {
                font-size: 1.8rem;
            }
            .kpi-label {
                font-size: 0.8rem;
            }
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Dashboard Reino da Barba</a>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Excel Import Section -->
        <div class="card mb-4">
            <div class="card-header">Importar Dados</div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <label for="excelFileInput" class="form-label">Selecione o arquivo Excel (.xlsx):</label>
                        <input type="file" class="form-control" id="excelFileInput" accept=".xlsx">
                    </div>
                    <div class="col-md-3 d-grid gap-2">
                        <button class="btn btn-primary" id="importExcelBtn">Importar Dados do Excel</button>
                    </div>
                    <div class="col-md-3 d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="executeAnalysisBtn" style="display: none;">Executar Análise</button>
                    </div>
                </div>
                <div id="importMessage" class="mt-3"></div>
                <div class="row mt-4">
                    <div class="col-md-4 d-grid gap-2">
                        <button class="btn btn-secondary" id="downloadBackupBtn">Download de Backup (JSON)</button>
                    </div>
                    <div class="col-md-4 d-grid gap-2">
                        <button class="btn btn-secondary" id="exportCsvBtn">Exportar CSV (Filtrado)</button>
                    </div>
                    <div class="col-md-4 d-grid gap-2">
                        <button class="btn btn-secondary" id="exportJsonBtn">Exportar JSON (Filtrado)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs Section -->
        <div class="card mb-4">
            <div class="card-header">Indicadores Chave (KPIs)</div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card kpi-card">
                            <div class="kpi-label">Faturamento Total</div>
                            <div class="kpi-value" id="kpiFaturamentoTotal">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card kpi-card">
                            <div class="kpi-label">Total de Clientes</div>
                            <div class="kpi-value" id="kpiTotalClientes">0</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card kpi-card">
                            <div class="kpi-label">Ticket Médio</div>
                            <div class="kpi-value" id="kpiTicketMedio">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card kpi-card">
                            <div class="kpi-label">Crescimento Mês a Mês</div>
                            <div class="kpi-value" id="kpiCrescimentoMesAMes">0.00%</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card kpi-card">
                            <div class="kpi-label">Comissão Jean</div>
                            <div class="kpi-value" id="kpiComissaoJean">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card kpi-card">
                            <div class="kpi-label">Comissão Salão</div>
                            <div class="kpi-value" id="kpiComissaoReinoDaBarba">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card kpi-card">
                            <div class="kpi-label">Meta Atingida</div>
                            <div class="kpi-value" id="kpiMetaAtingida">0.00%</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card kpi-card">
                            <div class="kpi-label">Taxa de Conversão</div>
                            <div class="kpi-value" id="kpiTaxaConversao">0.00%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="card mb-4">
            <div class="card-header">Filtros</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="filterStartDate" class="form-label">Data Inicial</label>
                        <input type="date" class="form-control" id="filterStartDate">
                    </div>
                    <div class="col-md-3">
                        <label for="filterEndDate" class="form-label">Data Final</label>
                        <input type="date" class="form-control" id="filterEndDate">
                    </div>
                    <div class="col-md-2">
                        <label for="filterYear" class="form-label">Ano</label>
                        <select class="form-select" id="filterYear">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterMonth" class="form-label">Mês</label>
                        <select class="form-select" id="filterMonth">
                            <option value="">Todos</option>
                            <option value="0">Janeiro</option>
                            <option value="1">Fevereiro</option>
                            <option value="2">Março</option>
                            <option value="3">Abril</option>
                            <option value="4">Maio</option>
                            <option value="5">Junho</option>
                            <option value="6">Julho</option>
                            <option value="7">Agosto</option>
                            <option value="8">Setembro</option>
                            <option value="9">Outubro</option>
                            <option value="10">Novembro</option>
                            <option value="11">Dezembro</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterQuinzena" class="form-label">Quinzena</label>
                        <select class="form-select" id="filterQuinzena">
                            <option value="">Todas</option>
                            <option value="Primeira">Primeira</option>
                            <option value="Segunda">Segunda</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterDayOfWeek" class="form-label">Dia da Semana</label>
                        <select class="form-select" id="filterDayOfWeek">
                            <option value="">Todos</option>
                            <option value="Dom">Domingo</option>
                            <option value="Seg">Segunda</option>
                            <option value="Ter">Terça</option>
                            <option value="Qua">Quarta</option>
                            <option value="Qui">Quinta</option>
                            <option value="Sex">Sexta</option>
                            <option value="Sab">Sábado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterService" class="form-label">Serviço</label>
                        <select class="form-select" id="filterService">
                            <option value="">Todos</option>
                            <option value="CABELO">CABELO</option>
                            <option value="BARBA">BARBA</option>
                            <option value="COMBO CABELO+BARBA">COMBO CABELO+BARBA</option>
                            <option value="SOBRANCELHA">SOBRANCELHA</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterPayment" class="form-label">Forma de Pagamento</label>
                        <select class="form-select" id="filterPayment">
                            <option value="">Todas</option>
                            <option value="PIX">PIX</option>
                            <option value="CRÉDITO">CRÉDITO</option>
                            <option value="DÉBITO">DÉBITO</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button class="btn btn-primary w-50" id="applyFiltersBtn">Aplicar Filtros</button>
                        <button class="btn btn-secondary w-50" id="clearFiltersBtn">Limpar Filtros</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Faturamento e Clientes Mensal</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="faturamentoClientesMensalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Receita por Tipo de Serviço</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="receitaServicoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Quantidade de Serviços</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="quantidadeServicosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Receita por Forma de Pagamento</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="receitaPagamentoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Faturamento por Dia da Semana</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="faturamentoDiaSemanaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Clientes vs Meta</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="clientesMetaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Comissão Jean vs Salão</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="comissaoJeanSalaoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Evolução de Pagamentos</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="evolucaoPagamentosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Summary Table Section -->
        <div class="card mb-4">
            <div class="card-header">Resumo Mensal</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="monthlySummaryTable">
                        <thead>
                            <tr>
                                <th>Mês/Ano</th>
                                <th>Faturamento</th>
                                <th>Clientes</th>
                                <th>Ticket Médio</th>
                                <th>Meta Faturamento</th>
                                <th>% Atingida</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- Chart.js Data Labels Plugin CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- SheetJS (xlsx.js) CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Register Chart.js Data Labels Plugin globally
        Chart.register(ChartDataLabels);

        let rawData = []; // Stores the original (or imported) processed data
        let filteredData = []; // Stores data after applying filters
        let currentCharts = {}; // Object to hold Chart.js instances

        const requiredColumns = [
            'ano', 'mes', 'dia', 'dia_semana', 'quinzenas', 'cliente', 'servico',
            'valor', 'pagto', 'comissao_jean', 'comissao_reino_da_barba',
            'meta_mensal', 'meta_clientes'
        ];

        const monthMap = {
            'JAN': 0, 'FEV': 1, 'MAR': 2, 'ABR': 3, 'MAI': 4, 'JUN': 5,
            'JUL': 6, 'AGO': 7, 'SET': 8, 'OUT': 9, 'NOV': 10, 'DEZ': 11
        };
        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        const dayOfWeekMap = {
            'Dom': 0, 'Seg': 1, 'Ter': 2, 'Qua': 3, 'Qui': 4, 'Sex': 5, 'Sab': 6
        };

        // --- Sample Data (Initial Load) ---
        const initialData = [
            { ano: 2024, mes: 'NOV', dia: 1, dia_semana: 'Sex', quinzenas: 'Primeira', cliente: 'João Silva', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'NOV', dia: 1, dia_semana: 'Sex', quinzenas: 'Primeira', cliente: 'Maria Souza', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'NOV', dia: 2, dia_semana: 'Sab', quinzenas: 'Primeira', cliente: 'Pedro Santos', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'NOV', dia: 3, dia_semana: 'Dom', quinzenas: 'Primeira', cliente: 'Ana Costa', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'NOV', dia: 4, dia_semana: 'Seg', quinzenas: 'Primeira', cliente: 'Carlos Lima', servico: 'SOBRANCELHA', valor: 25.00, pagto: 'CRÉDITO', comissao_jean: 12.50, comissao_reino_da_barba: 12.50, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'NOV', dia: 5, dia_semana: 'Ter', quinzenas: 'Primeira', cliente: 'Fernanda Alves', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'NOV', dia: 6, dia_semana: 'Qua', quinzenas: 'Primeira', cliente: 'Gustavo Rocha', servico: 'BARBA', valor: 40.00, pagto: 'DÉBITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'NOV', dia: 7, dia_semana: 'Qui', quinzenas: 'Primeira', cliente: 'Helena Pereira', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'CRÉDITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'NOV', dia: 8, dia_semana: 'Sex', quinzenas: 'Primeira', cliente: 'Igor Martins', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'NOV', dia: 9, dia_semana: 'Sab', quinzenas: 'Primeira', cliente: 'Julia Ribeiro', servico: 'SOBRANCELHA', valor: 25.00, pagto: 'DÉBITO', comissao_jean: 12.50, comissao_reino_da_barba: 12.50, meta_mensal: 5000, meta_clientes: 100 },
            { ano: 2024, mes: 'DEZ', dia: 1, dia_semana: 'Dom', quinzenas: 'Primeira', cliente: 'Lucas Silva', servico: 'CABELO', valor: 55.00, pagto: 'PIX', comissao_jean: 27.50, comissao_reino_da_barba: 27.50, meta_mensal: 6000, meta_clientes: 120 },
            { ano: 2024, mes: 'DEZ', dia: 2, dia_semana: 'Seg', quinzenas: 'Primeira', cliente: 'Mariana Santos', servico: 'BARBA', valor: 45.00, pagto: 'CRÉDITO', comissao_jean: 22.50, comissao_reino_da_barba: 22.50, meta_mensal: 6000, meta_clientes: 120 },
            { ano: 2025, mes: 'JAN', dia: 1, dia_semana: 'Qua', quinzenas: 'Primeira', cliente: 'Rafael Costa', servico: 'COMBO CABELO+BARBA', valor: 85.00, pagto: 'PIX', comissao_jean: 42.50, comissao_reino_da_barba: 42.50, meta_mensal: 5500, meta_clientes: 110 },
            { ano: 2025, mes: 'JAN', dia: 2, dia_semana: 'Qui', quinzenas: 'Primeira', cliente: 'Beatriz Lima', servico: 'CABELO', valor: 50.00, pagto: 'DÉBITO', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5500, meta_clientes: 110 },
            { ano: 2025, mes: 'FEV', dia: 1, dia_semana: 'Sab', quinzenas: 'Primeira', cliente: 'Thiago Alves', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 5200, meta_clientes: 105 },
            { ano: 2025, mes: 'FEV', dia: 2, dia_semana: 'Dom', quinzenas: 'Primeira', cliente: 'Camila Rocha', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5200, meta_clientes: 105 },
            { ano: 2025, mes: 'MAR', dia: 1, dia_semana: 'Sab', quinzenas: 'Primeira', cliente: 'Daniel Pereira', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 5800, meta_clientes: 115 },
            { ano: 2025, mes: 'MAR', dia: 2, dia_semana: 'Dom', quinzenas: 'Primeira', cliente: 'Larissa Martins', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5800, meta_clientes: 115 },
            { ano: 2025, mes: 'ABR', dia: 1, dia_semana: 'Ter', quinzenas: 'Primeira', cliente: 'Felipe Ribeiro', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 5300, meta_clientes: 108 },
            { ano: 2025, mes: 'ABR', dia: 2, dia_semana: 'Qua', quinzenas: 'Primeira', cliente: 'Isabela Costa', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5300, meta_clientes: 108 },
            { ano: 2025, mes: 'MAI', dia: 1, dia_semana: 'Qui', quinzenas: 'Primeira', cliente: 'Guilherme Lima', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6200, meta_clientes: 125 },
            { ano: 2025, mes: 'MAI', dia: 2, dia_semana: 'Sex', quinzenas: 'Primeira', cliente: 'Manuela Alves', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6200, meta_clientes: 125 },
            { ano: 2025, mes: 'JUN', dia: 1, dia_semana: 'Dom', quinzenas: 'Primeira', cliente: 'João Silva', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 5700, meta_clientes: 112 },
            { ano: 2025, mes: 'JUN', dia: 2, dia_semana: 'Seg', quinzenas: 'Primeira', cliente: 'Maria Souza', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5700, meta_clientes: 112 },
            { ano: 2025, mes: 'JUL', dia: 1, dia_semana: 'Ter', quinzenas: 'Primeira', cliente: 'Pedro Santos', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6000, meta_clientes: 120 },
            { ano: 2025, mes: 'JUL', dia: 2, dia_semana: 'Qua', quinzenas: 'Primeira', cliente: 'Ana Costa', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6000, meta_clientes: 120 },
            { ano: 2025, mes: 'AGO', dia: 1, dia_semana: 'Sex', quinzenas: 'Primeira', cliente: 'Carlos Lima', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 5900, meta_clientes: 118 },
            { ano: 2025, mes: 'AGO', dia: 2, dia_semana: 'Sab', quinzenas: 'Primeira', cliente: 'Fernanda Alves', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5900, meta_clientes: 118 },
            { ano: 2025, mes: 'SET', dia: 1, dia_semana: 'Seg', quinzenas: 'Primeira', cliente: 'Gustavo Rocha', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6100, meta_clientes: 122 },
            { ano: 2025, mes: 'SET', dia: 2, dia_semana: 'Ter', quinzenas: 'Primeira', cliente: 'Helena Pereira', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6100, meta_clientes: 122 },
            { ano: 2025, mes: 'OUT', dia: 1, dia_semana: 'Qua', quinzenas: 'Primeira', cliente: 'Igor Martins', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 5600, meta_clientes: 110 },
            { ano: 2025, mes: 'OUT', dia: 2, dia_semana: 'Qui', quinzenas: 'Primeira', cliente: 'Julia Ribeiro', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 5600, meta_clientes: 110 },
            { ano: 2025, mes: 'NOV', dia: 1, dia_semana: 'Sab', quinzenas: 'Primeira', cliente: 'Lucas Silva', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6300, meta_clientes: 130 },
            { ano: 2025, mes: 'NOV', dia: 2, dia_semana: 'Dom', quinzenas: 'Primeira', cliente: 'Mariana Santos', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6300, meta_clientes: 130 },
            { ano: 2025, mes: 'DEZ', dia: 1, dia_semana: 'Seg', quinzenas: 'Primeira', cliente: 'Rafael Costa', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 2, dia_semana: 'Ter', quinzenas: 'Primeira', cliente: 'Beatriz Lima', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 3, dia_semana: 'Qua', quinzenas: 'Primeira', cliente: 'Thiago Alves', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 4, dia_semana: 'Qui', quinzenas: 'Primeira', cliente: 'Camila Rocha', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 5, dia_semana: 'Sex', quinzenas: 'Primeira', cliente: 'Daniel Pereira', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 6, dia_semana: 'Sab', quinzenas: 'Primeira', cliente: 'Larissa Martins', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 7, dia_semana: 'Dom', quinzenas: 'Primeira', cliente: 'Felipe Ribeiro', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.0ao, comissao_reino_da_barba: 40.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 8, dia_semana: 'Seg', quinzenas: 'Primeira', cliente: 'Isabela Costa', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 9, dia_semana: 'Ter', quinzenas: 'Primeira', cliente: 'Guilherme Lima', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 10, dia_semana: 'Qua', quinzenas: 'Primeira', cliente: 'Manuela Alves', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 11, dia_semana: 'Qui', quinzenas: 'Primeira', cliente: 'João Silva', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 12, dia_semana: 'Sex', quinzenas: 'Primeira', cliente: 'Maria Souza', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 13, dia_semana: 'Sab', quinzenas: 'Primeira', cliente: 'Pedro Santos', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 14, dia_semana: 'Dom', quinzenas: 'Primeira', cliente: 'Ana Costa', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 15, dia_semana: 'Seg', quinzenas: 'Primeira', cliente: 'Carlos Lima', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 16, dia_semana: 'Ter', quinzenas: 'Segunda', cliente: 'Fernanda Alves', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 17, dia_semana: 'Qua', quinzenas: 'Segunda', cliente: 'Gustavo Rocha', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 18, dia_semana: 'Qui', quinzenas: 'Segunda', cliente: 'Helena Pereira', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 19, dia_semana: 'Sex', quinzenas: 'Segunda', cliente: 'Igor Martins', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 20, dia_semana: 'Sab', quinzenas: 'Segunda', cliente: 'Julia Ribeiro', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 21, dia_semana: 'Dom', quinzenas: 'Segunda', cliente: 'Lucas Silva', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 22, dia_semana: 'Seg', quinzenas: 'Segunda', cliente: 'Mariana Santos', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 23, dia_semana: 'Ter', quinzenas: 'Segunda', cliente: 'Rafael Costa', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 24, dia_semana: 'Qua', quinzenas: 'Segunda', cliente: 'Beatriz Lima', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 25, dia_semana: 'Qui', quinzenas: 'Segunda', cliente: 'Thiago Alves', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 26, dia_semana: 'Sex', quinzenas: 'Segunda', cliente: 'Camila Rocha', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 27, dia_semana: 'Sab', quinzenas: 'Segunda', cliente: 'Daniel Pereira', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 28, dia_semana: 'Dom', quinzenas: 'Segunda', cliente: 'Larissa Martins', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 29, dia_semana: 'Seg', quinzenas: 'Segunda', cliente: 'Felipe Ribeiro', servico: 'BARBA', valor: 40.00, pagto: 'CRÉDITO', comissao_jean: 20.00, comissao_reino_da_barba: 20.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 30, dia_semana: 'Ter', quinzenas: 'Segunda', cliente: 'Isabela Costa', servico: 'COMBO CABELO+BARBA', valor: 80.00, pagto: 'DÉBITO', comissao_jean: 40.00, comissao_reino_da_barba: 40.00, meta_mensal: 6500, meta_clientes: 135 },
            { ano: 2025, mes: 'DEZ', dia: 31, dia_semana: 'Qua', quinzenas: 'Segunda', cliente: 'Guilherme Lima', servico: 'CABELO', valor: 50.00, pagto: 'PIX', comissao_jean: 25.00, comissao_reino_da_barba: 25.00, meta_mensal: 6500, meta_clientes: 135 }
        ];


        // --- Helper Functions ---
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatPercentage(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }

        function displayMessage(message, type = 'info') {
            const msgDiv = document.getElementById('importMessage');
            msgDiv.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        }

        function processData(data) {
            return data.map(row => {
                const mesNumero = typeof row.mes === 'string' ? monthMap[row.mes.toUpperCase()] : row.mes;
                const diaSemanaNumero = typeof row.dia_semana === 'string' ? dayOfWeekMap[row.dia_semana] : row.dia_semana;

                // Ensure values are numbers
                row.valor = parseFloat(row.valor) || 0;
                row.comissao_jean = parseFloat(row.comissao_jean) || 0;
                row.comissao_reino_da_barba = parseFloat(row.comissao_reino_da_barba) || 0;
                row.meta_mensal = parseFloat(row.meta_mensal) || 0;
                row.meta_clientes = parseFloat(row.meta_clientes) || 0;

                // Create a Date object for easier filtering
                const date = new Date(row.ano, mesNumero, row.dia);

                return {
                    ...row,
                    mes_numero: mesNumero,
                    dia_semana_numero: diaSemanaNumero,
                    data_completa: date
                };
            });
        }

        function validateColumns(data) {
            if (!data || data.length === 0) {
                return false;
            }
            const actualColumns = Object.keys(data[0]);
            const missingColumns = requiredColumns.filter(col => !actualColumns.includes(col));
            if (missingColumns.length > 0) {
                displayMessage(`Erro: As seguintes colunas obrigatórias estão faltando no seu arquivo Excel: ${missingColumns.join(', ')}.`, 'danger');
                return false;
            }
            return true;
        }

        // --- Excel Import Logic ---
        document.getElementById('importExcelBtn').addEventListener('click', () => {
            document.getElementById('excelFileInput').click();
        });

        document.getElementById('excelFileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    if (validateColumns(json)) {
                        rawData = processData(json);
                        displayMessage(`Arquivo "${file.name}" importado com sucesso! Clique em "Executar Análise" para atualizar o dashboard.`, 'success');
                        document.getElementById('executeAnalysisBtn').style.display = 'block';
                        document.getElementById('importExcelBtn').style.display = 'none';
                    } else {
                        rawData = []; // Clear data if validation fails
                        document.getElementById('executeAnalysisBtn').style.display = 'none';
                        document.getElementById('importExcelBtn').style.display = 'block';
                    }
                } catch (error) {
                    displayMessage(`Erro ao ler o arquivo Excel: ${error.message}`, 'danger');
                    rawData = [];
                    document.getElementById('executeAnalysisBtn').style.display = 'none';
                    document.getElementById('importExcelBtn').style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('executeAnalysisBtn').addEventListener('click', () => {
            filteredData = [...rawData]; // Reset filtered data to raw data
            renderDashboard();
            displayMessage('Análise executada com sucesso com os novos dados!', 'success');
            document.getElementById('executeAnalysisBtn').style.display = 'none';
            document.getElementById('importExcelBtn').style.display = 'block';
        });

        // --- Filter Logic ---
        function populateFilterOptions() {
            const years = [...new Set(rawData.map(d => d.ano))].sort((a, b) => a - b);
            const yearFilter = document.getElementById('filterYear');
            yearFilter.innerHTML = '<option value="">Todos</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }

        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

        function applyFilters() {
            let currentFilteredData = [...rawData];

            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const year = document.getElementById('filterYear').value;
            const month = document.getElementById('filterMonth').value;
            const quinzena = document.getElementById('filterQuinzena').value;
            const dayOfWeek = document.getElementById('filterDayOfWeek').value;
            const service = document.getElementById('filterService').value;
            const payment = document.getElementById('filterPayment').value;

            if (startDate) {
                const start = new Date(startDate);
                currentFilteredData = currentFilteredData.filter(d => d.data_completa >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999); // Include end day
                currentFilteredData = currentFilteredData.filter(d => d.data_completa <= end);
            }
            if (year) {
                currentFilteredData = currentFilteredData.filter(d => d.ano == year);
            }
            if (month !== '') {
                currentFilteredData = currentFilteredData.filter(d => d.mes_numero == month);
            }
            if (quinzena) {
                currentFilteredData = currentFilteredData.filter(d => d.quinzenas === quinzena);
            }
            if (dayOfWeek) {
                currentFilteredData = currentFilteredData.filter(d => d.dia_semana === dayOfWeek);
            }
            if (service) {
                currentFilteredData = currentFilteredData.filter(d => d.servico === service);
            }
            if (payment) {
                currentFilteredData = currentFilteredData.filter(d => d.pagto === payment);
            }

            filteredData = currentFilteredData;
            renderDashboard();
        }

        function clearFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterQuinzena').value = '';
            document.getElementById('filterDayOfWeek').value = '';
            document.getElementById('filterService').value = '';
            document.getElementById('filterPayment').value = '';
            filteredData = [...rawData];
            renderDashboard();
        }

        // --- KPI Calculations ---
        function calculateKPIs(data) {
            const totalFaturamento = data.reduce((sum, row) => sum + row.valor, 0);
            const totalClientes = data.length; // Each row is an attendance/client
            const ticketMedio = totalClientes > 0 ? totalFaturamento / totalClientes : 0;

            // For Growth M-o-M and Meta Atingida, we need monthly aggregation
            const monthlyData = data.reduce((acc, row) => {
                const monthKey = `${row.ano}-${row.mes_numero}`;
                if (!acc[monthKey]) {
                    acc[monthKey] = { faturamento: 0, clientes: 0, meta_mensal: 0, meta_clientes: 0 };
                }
                acc[monthKey].faturamento += row.valor;
                acc[monthKey].clientes += 1;
                // Meta should be unique per month, so take the first one found for that month
                if (acc[monthKey].meta_mensal === 0) acc[monthKey].meta_mensal = row.meta_mensal;
                if (acc[monthKey].meta_clientes === 0) acc[monthKey].meta_clientes = row.meta_clientes;
                return acc;
            }, {});

            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            let crescimentoMesAMes = 0;
            if (sortedMonths.length >= 2) {
                const currentMonthKey = sortedMonths[sortedMonths.length - 1];
                const prevMonthKey = sortedMonths[sortedMonths.length - 2];
                const currentFaturamento = monthlyData[currentMonthKey].faturamento;
                const prevFaturamento = monthlyData[prevMonthKey].faturamento;
                if (prevFaturamento > 0) {
                    crescimentoMesAMes = (currentFaturamento - prevFaturamento) / prevFaturamento;
                }
            }

            const totalMetaMensal = Object.values(monthlyData).reduce((sum, m) => sum + m.meta_mensal, 0);
            const metaAtingida = totalMetaMensal > 0 ? totalFaturamento / totalMetaMensal : 0;

            const totalMetaClientes = Object.values(monthlyData).reduce((sum, m) => sum + m.meta_clientes, 0);
            const taxaConversao = totalMetaClientes > 0 ? totalClientes / totalMetaClientes : 0;

            const comissaoJean = data.reduce((sum, row) => sum + row.comissao_jean, 0);
            const comissaoReinoDaBarba = data.reduce((sum, row) => sum + row.comissao_reino_da_barba, 0);

            return {
                totalFaturamento,
                totalClientes,
                ticketMedio,
                crescimentoMesAMes,
                comissaoJean,
                comissaoReinoDaBarba,
                metaAtingida,
                taxaConversao
            };
        }

        function updateKPIs(kpis) {
            document.getElementById('kpiFaturamentoTotal').textContent = formatCurrency(kpis.totalFaturamento);
            document.getElementById('kpiTotalClientes').textContent = kpis.totalClientes.toLocaleString('pt-BR');
            document.getElementById('kpiTicketMedio').textContent = formatCurrency(kpis.ticketMedio);
            document.getElementById('kpiCrescimentoMesAMes').textContent = formatPercentage(kpis.crescimentoMesAMes);
            document.getElementById('kpiComissaoJean').textContent = formatCurrency(kpis.comissaoJean);
            document.getElementById('kpiComissaoReinoDaBarba').textContent = formatCurrency(kpis.comissaoReinoDaBarba);
            document.getElementById('kpiMetaAtingida').textContent = formatPercentage(kpis.metaAtingida);
            document.getElementById('kpiTaxaConversao').textContent = formatPercentage(kpis.taxaConversao);
        }

        // --- Chart Functions ---
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'var(--text-color)'
                    }
                },
                datalabels: {
                    color: 'var(--text-color)',
                    font: {
                        weight: 'bold'
                    },
                    formatter: (value, context) => {
                        if (context.chart.config.type === 'pie' || context.chart.config.type === 'doughnut') {
                            const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                            const percentage = (value / total * 100).toFixed(1) + '%';
                            return percentage;
                        }
                        return value.toLocaleString('pt-BR');
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'var(--border-color)' },
                    ticks: { color: 'var(--text-color)' }
                },
                y: {
                    grid: { color: 'var(--border-color)' },
                    ticks: { color: 'var(--text-color)' }
                }
            }
        };

        function createOrUpdateChart(chartId, type, data, options) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if (currentCharts[chartId]) {
                currentCharts[chartId].destroy();
            }
            currentCharts[chartId] = new Chart(ctx, {
                type: type,
                data: data,
                options: options
            });
        }

        function updateFaturamentoClientesMensalChart(data) {
            const monthlyAgg = data.reduce((acc, row) => {
                const monthYear = `${monthNames[row.mes_numero]}/${row.ano}`;
                if (!acc[monthYear]) {
                    acc[monthYear] = { faturamento: 0, clientes: 0 };
                }
                acc[monthYear].faturamento += row.valor;
                acc[monthYear].clientes += 1;
                return acc;
            }, {});

            const labels = Object.keys(monthlyAgg).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map((s, i) => i === 0 ? monthNames.indexOf(s) : Number(s));
                const [monthB, yearB] = b.split('/').map((s, i) => i === 0 ? monthNames.indexOf(s) : Number(s));
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            const faturamentoData = labels.map(label => monthlyAgg[label].faturamento);
            const clientesData = labels.map(label => monthlyAgg[label].clientes);

            createOrUpdateChart('faturamentoClientesMensalChart', 'bar', {
                labels: labels,
                datasets: [
                    {
                        label: 'Faturamento (R$)',
                        data: faturamentoData,
                        backgroundColor: 'var(--accent-color)',
                        borderColor: 'var(--accent-color)',
                        type: 'bar',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Clientes',
                        data: clientesData,
                        backgroundColor: 'rgba(173, 216, 230, 0.7)', // Light blue for clients
                        borderColor: 'rgba(173, 216, 230, 1)',
                        type: 'line',
                        fill: false,
                        yAxisID: 'y1'
                    }
                ]
            }, {
                ...chartOptions,
                scales: {
                    x: { ...chartOptions.scales.x },
                    y: { ...chartOptions.scales.y, beginAtZero: true, type: 'linear', position: 'left', title: { display: true, text: 'Faturamento (R$)', color: 'var(--text-color)' } },
                    y1: { ...chartOptions.scales.y, beginAtZero: true, type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Clientes', color: 'var(--text-color)' } }
                }
            });
        }

        function updateReceitaServicoChart(data) {
            const serviceAgg = data.reduce((acc, row) => {
                acc[row.servico] = (acc[row.servico] || 0) + row.valor;
                return acc;
            }, {});

            const labels = Object.keys(serviceAgg);
            const values = Object.values(serviceAgg);

            createOrUpdateChart('receitaServicoChart', 'pie', {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#d4af37', '#8B4513', '#A9A9A9', '#FFD700'], // Gold, SaddleBrown, DarkGray, Gold
                    borderColor: 'var(--primary-bg)',
                    borderWidth: 2
                }]
            }, {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    datalabels: {
                        color: 'var(--primary-bg)', // Dark text for labels on light pie slices
                        formatter: (value, context) => {
                            const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                            const percentage = (value / total * 100).toFixed(1) + '%';
                            return percentage;
                        }
                    }
                }
            });
        }

        function updateQuantidadeServicosChart(data) {
            const serviceCount = data.reduce((acc, row) => {
                acc[row.servico] = (acc[row.servico] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(serviceCount);
            const values = Object.values(serviceCount);

            createOrUpdateChart('quantidadeServicosChart', 'bar', {
                labels: labels,
                datasets: [{
                    label: 'Quantidade de Serviços',
                    data: values,
                    backgroundColor: 'rgba(212, 175, 55, 0.7)',
                    borderColor: 'var(--accent-color)',
                    borderWidth: 1
                }]
            }, chartOptions);
        }

        function updateReceitaPagamentoChart(data) {
            const paymentAgg = data.reduce((acc, row) => {
                acc[row.pagto] = (acc[row.pagto] || 0) + row.valor;
                return acc;
            }, {});

            const labels = Object.keys(paymentAgg);
            const values = Object.values(paymentAgg);

            createOrUpdateChart('receitaPagamentoChart', 'pie', {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#d4af37', '#A9A9A9', '#8B4513'], // Gold, DarkGray, SaddleBrown
                    borderColor: 'var(--primary-bg)',
                    borderWidth: 2
                }]
            }, {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    datalabels: {
                        color: 'var(--primary-bg)',
                        formatter: (value, context) => {
                            const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                            const percentage = (value / total * 100).toFixed(1) + '%';
                            return percentage;
                        }
                    }
                }
            });
        }

        function updateFaturamentoDiaSemanaChart(data) {
            const dayOfWeekOrder = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
            const dayAgg = data.reduce((acc, row) => {
                acc[row.dia_semana] = (acc[row.dia_semana] || 0) + row.valor;
                return acc;
            }, {});

            const labels = dayOfWeekOrder;
            const values = dayOfWeekOrder.map(day => dayAgg[day] || 0);

            createOrUpdateChart('faturamentoDiaSemanaChart', 'bar', {
                labels: labels,
                datasets: [{
                    label: 'Faturamento (R$)',
                    data: values,
                    backgroundColor: 'rgba(212, 175, 55, 0.7)',
                    borderColor: 'var(--accent-color)',
                    borderWidth: 1
                }]
            }, chartOptions);
        }

        function updateClientesMetaChart(data) {
            const monthlyAgg = data.reduce((acc, row) => {
                const monthYear = `${monthNames[row.mes_numero]}/${row.ano}`;
                if (!acc[monthYear]) {
                    acc[monthYear] = { clientes: 0, meta_clientes: 0 };
                }
                acc[monthYear].clientes += 1;
                // Meta should be unique per month, so take the first one found for that month
                if (acc[monthYear].meta_clientes === 0) acc[monthYear].meta_clientes = row.meta_clientes;
                return acc;
            }, {});

            const labels = Object.keys(monthlyAgg).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map((s, i) => i === 0 ? monthNames.indexOf(s) : Number(s));
                const [monthB, yearB] = b.split('/').map((s, i) => i === 0 ? monthNames.indexOf(s) : Number(s));
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            const clientesData = labels.map(label => monthlyAgg[label].clientes);
            const metaClientesData = labels.map(label => monthlyAgg[label].meta_clientes);

            createOrUpdateChart('clientesMetaChart', 'bar', {
                labels: labels,
                datasets: [
                    {
                        label: 'Clientes Atendidos',
                        data: clientesData,
                        backgroundColor: 'var(--accent-color)',
                        borderColor: 'var(--accent-color)',
                        type: 'bar'
                    },
                    {
                        label: 'Meta de Clientes',
                        data: metaClientesData,
                        backgroundColor: 'rgba(173, 216, 230, 0.7)', // Light blue for meta
                        borderColor: 'rgba(173, 216, 230, 1)',
                        type: 'line',
                        fill: false
                    }
                ]
            }, chartOptions);
        }

        function updateComissaoJeanSalaoChart(data) {
            const monthlyAgg = data.reduce((acc, row) => {
                const monthYear = `${monthNames[row.mes_numero]}/${row.ano}`;
                if (!acc[monthYear]) {
                    acc[monthYear] = { jean: 0, salao: 0 };
                }
                acc[monthYear].jean += row.comissao_jean;
                acc[monthYear].salao += row.comissao_reino_da_barba;
                return acc;
            }, {});

            const labels = Object.keys(monthlyAgg).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map((s, i) => i === 0 ? monthNames.indexOf(s) : Number(s));
                const [monthB, yearB] = b.split('/').map((s, i) => i === 0 ? monthNames.indexOf(s) : Number(s));
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            const jeanData = labels.map(label => monthlyAgg[label].jean);
            const salaoData = labels.map(label => monthlyAgg[label].salao);

            createOrUpdateChart('comissaoJeanSalaoChart', 'bar', {
                labels: labels,
                datasets: [
                    {
                        label: 'Comissão Jean (R$)',
                        data: jeanData,
                        backgroundColor: 'var(--accent-color)',
                        borderColor: 'var(--accent-color)',
                        borderWidth: 1
                    },
                    {
                        label: 'Comissão Salão (R$)',
                        data: salaoData,
                        backgroundColor: 'rgba(173, 216, 230, 0.7)', // Light blue
                        borderColor: 'rgba(173, 216, 230, 1)',
                        borderWidth: 1
                    }
                ]
            }, {
                ...chartOptions,
                scales: {
                    x: { ...chartOptions.scales.x, stacked: true },
                    y: { ...chartOptions.scales.y, stacked: true }
                }
            });
        }

        function updateEvolucaoPagamentosChart(data) {
            const monthlyAgg = data.reduce((acc, row) => {
                const monthYear = `${monthNames[row.mes_numero]}/${row.ano}`;
                if (!acc[monthYear]) {
                    acc[monthYear] = { PIX: 0, CRÉDITO: 0, DÉBITO: 0 };
                }
                acc[monthYear][row.pagto] = (acc[monthYear][row.pagto] || 0) + row.valor;
                return acc;
            }, {});

            const labels = Object.keys(monthlyAgg).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map((s, i) => i === 0 ? monthNames.indexOf(s) : Number(s));
                const [monthB, yearB] = b.split('/').map((s, i) => i === 0 ? monthNames.indexOf(s) : Number(s));
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            const pixData = labels.map(label => monthlyAgg[label].PIX || 0);
            const creditoData = labels.map(label => monthlyAgg[label].CRÉDITO || 0);
            const debitoData = labels.map(label => monthlyAgg[label].DÉBITO || 0);

            createOrUpdateChart('evolucaoPagamentosChart', 'bar', {
                labels: labels,
                datasets: [
                    {
                        label: 'PIX',
                        data: pixData,
                        backgroundColor: '#d4af37', // Gold
                        borderColor: '#d4af37',
                        borderWidth: 1
                    },
                    {
                        label: 'CRÉDITO',
                        data: creditoData,
                        backgroundColor: '#A9A9A9', // DarkGray
                        borderColor: '#A9A9A9',
                        borderWidth: 1
                    },
                    {
                        label: 'DÉBITO',
                        data: debitoData,
                        backgroundColor: '#8B4513', // SaddleBrown
                        borderColor: '#8B4513',
                        borderWidth: 1
                    }
                ]
            }, {
                ...chartOptions,
                scales: {
                    x: { ...chartOptions.scales.x, stacked: true },
                    y: { ...chartOptions.scales.y, stacked: true }
                }
            });
        }

        // --- Monthly Summary Table ---
        function updateMonthlySummaryTable(data) {
            const tableBody = document.getElementById('monthlySummaryTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear existing rows

            const monthlyAgg = data.reduce((acc, row) => {
                const monthYearKey = `${row.ano}-${row.mes_numero}`;
                if (!acc[monthYearKey]) {
                    acc[monthYearKey] = {
                        faturamento: 0,
                        clientes: 0,
                        meta_faturamento: 0,
                        meta_clientes: 0,
                        monthName: monthNames[row.mes_numero],
                        year: row.ano
                    };
                }
                acc[monthYearKey].faturamento += row.valor;
                acc[monthYearKey].clientes += 1;
                // Meta should be unique per month, so take the first one found for that month
                if (acc[monthYearKey].meta_faturamento === 0) acc[monthYearKey].meta_faturamento = row.meta_mensal;
                if (acc[monthYearKey].meta_clientes === 0) acc[monthYearKey].meta_clientes = row.meta_clientes;
                return acc;
            }, {});

            const sortedMonths = Object.keys(monthlyAgg).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            sortedMonths.forEach(key => {
                const monthData = monthlyAgg[key];
                const ticketMedio = monthData.clientes > 0 ? monthData.faturamento / monthData.clientes : 0;
                const percentAtingida = monthData.meta_faturamento > 0 ? monthData.faturamento / monthData.meta_faturamento : 0;

                const row = tableBody.insertRow();
                row.insertCell().textContent = `${monthData.monthName}/${monthData.year}`;
                row.insertCell().textContent = formatCurrency(monthData.faturamento);
                row.insertCell().textContent = monthData.clientes.toLocaleString('pt-BR');
                row.insertCell().textContent = formatCurrency(ticketMedio);
                row.insertCell().textContent = formatCurrency(monthData.meta_faturamento);
                row.insertCell().textContent = formatPercentage(percentAtingida);
            });
        }

        // --- Export Functions ---
        function downloadFile(data, filename, type) {
            const blob = new Blob([data], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            if (filteredData.length === 0) {
                displayMessage('Nenhum dado para exportar. Aplique filtros ou importe dados.', 'warning');
                return;
            }
            const headers = Object.keys(filteredData[0]);
            const csv = [
                headers.join(','),
                ...filteredData.map(row => headers.map(fieldName => JSON.stringify(row[fieldName])).join(','))
            ].join('\n');
            downloadFile(csv, 'dados_filtrados_reino_da_barba.csv', 'text/csv');
        });

        document.getElementById('exportJsonBtn').addEventListener('click', () => {
            if (filteredData.length === 0) {
                displayMessage('Nenhum dado para exportar. Aplique filtros ou importe dados.', 'warning');
                return;
            }
            downloadFile(JSON.stringify(filteredData, null, 2), 'dados_filtrados_reino_da_barba.json', 'application/json');
        });

        document.getElementById('downloadBackupBtn').addEventListener('click', () => {
            if (rawData.length === 0) {
                displayMessage('Nenhum dado de backup disponível. Importe um arquivo Excel primeiro.', 'warning');
                return;
            }
            downloadFile(JSON.stringify(rawData, null, 2), 'backup_dados_reino_da_barba.json', 'application/json');
        });


        // --- Main Render Function ---
        function renderDashboard() {
            if (filteredData.length === 0) {
                displayMessage('Nenhum dado disponível para exibir. Importe um arquivo Excel ou verifique os filtros.', 'warning');
                // Clear all charts and KPIs if no data
                Object.values(currentCharts).forEach(chart => chart.destroy());
                currentCharts = {};
                updateKPIs({
                    totalFaturamento: 0, totalClientes: 0, ticketMedio: 0,
                    crescimentoMesAMes: 0, comissaoJean: 0, comissaoReinoDaBarba: 0,
                    metaAtingida: 0, taxaConversao: 0
                });
                document.getElementById('monthlySummaryTable').getElementsByTagName('tbody')[0].innerHTML = '';
                return;
            }

            const kpis = calculateKPIs(filteredData);
            updateKPIs(kpis);

            updateFaturamentoClientesMensalChart(filteredData);
            updateReceitaServicoChart(filteredData);
            updateQuantidadeServicosChart(filteredData);
            updateReceitaPagamentoChart(filteredData);
            updateFaturamentoDiaSemanaChart(filteredData);
            updateClientesMetaChart(filteredData);
            updateComissaoJeanSalaoChart(filteredData);
            updateEvolucaoPagamentosChart(filteredData);

            updateMonthlySummaryTable(filteredData);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            rawData = processData(initialData);
            filteredData = [...rawData];
            populateFilterOptions();
            renderDashboard();
            displayMessage('Dashboard carregado com dados de exemplo. Importe seu próprio Excel para atualizar.', 'info');
        });
    </script>
</body>
</html>
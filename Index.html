<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REINO DA BARBA - DASHBOARD DE FATURAMENTO</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Chart.js CSS (optional, but good for consistency) -->
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-bg: #1a1a1a; /* Dark background */
            --secondary-bg: #2a2a2a; /* Slightly lighter dark for cards */
            --text-color: #f8f9fa; /* Light text */
            --accent-color: #d4af37; /* Golden accent */
            --border-color: #444; /* Darker border */
            --success-color: #28a745; /* Green for success */
            --danger-color: #dc3545; /* Red for error */
            --table-header-bg: #333;
            --table-row-even: #2a2a2a;
            --table-row-odd: #333;
            --table-text-color: #e9ecef; /* Light gray for table text */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .navbar {
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand {
            color: var(--accent-color) !important;
            font-weight: bold;
            font-size: 1.8rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 1rem;
        }

        .card-header {
            background-color: var(--table-header-bg);
            color: var(--accent-color);
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1.25rem;
        }

        .card-body {
            padding: 1.25rem;
        }

        .kpi-card {
            text-align: center;
            padding: 1rem;
            transition: transform 0.2s ease-in-out;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 0.5rem;
            line-height: 1.2;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .chart-container {
            height: 300px; /* Fixed height for charts */
            margin-bottom: 1rem;
        }

        canvas {
            background-color: var(--secondary-bg);
            border-radius: 0.5rem;
            padding: 10px;
        }

        .form-label {
            color: var(--text-color);
            font-weight: bold;
        }

        .form-control, .form-select {
            background-color: var(--primary-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--primary-bg);
            color: var(--text-color);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25); /* Golden glow */
        }

        .form-check-input {
            background-color: var(--primary-bg);
            border-color: var(--border-color);
        }

        .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--primary-bg);
            font-weight: bold;
        }

        .btn-primary:hover {
            background-color: #c0a030; /* Slightly darker gold */
            border-color: #c0a030;
        }

        .btn-success-custom {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
            font-weight: bold;
        }
        .btn-success-custom:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
            font-weight: bold;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        .alert {
            margin-top: 1rem;
        }

        .table {
            background-color: var(--secondary-bg);
            color: var(--table-text-color); /* Corrected table text color */
            border: 1px solid var(--border-color);
        }

        .table th {
            background-color: var(--table-header-bg);
            color: var(--accent-color);
            border-color: var(--border-color);
        }

        .table td {
            border-color: var(--border-color);
        }

        .table tbody tr:nth-of-type(odd) {
            background-color: var(--table-row-odd);
        }

        .table tbody tr:nth-of-type(even) {
            background-color: var(--table-row-even);
        }

        .footer {
            background-color: var(--secondary-bg);
            color: var(--text-color);
            padding: 1rem 0;
            text-align: center;
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #c0a030;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">REINO DA BARBA - DASHBOARD DE FATURAMENTO</a>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- Import Section -->
        <div class="card mb-4">
            <div class="card-header">Importação de Dados</div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <label for="excelFileInput" class="form-label">Selecione o arquivo Excel (.xlsx):</label>
                        <input type="file" class="form-control" id="excelFileInput" accept=".xlsx">
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <button class="btn btn-primary w-100" id="importExcelBtn">Importar Dados do Excel</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success-custom w-100 d-none" id="executeAnalysisBtn">Executar Análise</button>
                    </div>
                </div>
                <div id="messageArea" class="mt-3"></div>
                <div class="row mt-3">
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-outline-light w-100" id="exportCsvBtn">Exportar CSV</button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-outline-light w-100" id="exportJsonBtn">Exportar JSON</button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-outline-light w-100" id="downloadBackupBtn">Download Backup (JSON)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs Section -->
        <div class="card mb-4">
            <div class="card-header">Indicadores Chave (KPIs)</div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="kpi-card">
                            <div class="kpi-label">Faturamento Total</div>
                            <div class="kpi-value" id="kpiFaturamentoTotal">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="kpi-card">
                            <div class="kpi-label">Total de Clientes</div>
                            <div class="kpi-value" id="kpiTotalClientes">0</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="kpi-card">
                            <div class="kpi-label">Ticket Médio</div>
                            <div class="kpi-value" id="kpiTicketMedio">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="kpi-card">
                            <div class="kpi-label">Crescimento Mês a Mês</div>
                            <div class="kpi-value" id="kpiCrescimentoMes">0.00%</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="kpi-card">
                            <div class="kpi-label">Comissão Jean</div>
                            <div class="kpi-value" id="kpiComissaoJean">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="kpi-card">
                            <div class="kpi-label">Comissão Salão</div>
                            <div class="kpi-value" id="kpiComissaoReino">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="kpi-card">
                            <div class="kpi-label">Meta Atingida</div>
                            <div class="kpi-value" id="kpiMetaAtingida">0.00%</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="kpi-card">
                            <div class="kpi-label">Taxa de Conversão</div>
                            <div class="kpi-value" id="kpiTaxaConversao">0.00%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="card mb-4">
            <div class="card-header">Filtros Avançados</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="filterStartDate" class="form-label">Data Inicial:</label>
                        <input type="date" class="form-control" id="filterStartDate">
                    </div>
                    <div class="col-md-3">
                        <label for="filterEndDate" class="form-label">Data Final:</label>
                        <input type="date" class="form-control" id="filterEndDate">
                    </div>
                    <div class="col-md-3">
                        <label for="filterYear" class="form-label">Ano:</label>
                        <select class="form-select" id="filterYear" multiple size="3"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterMonth" class="form-label">Mês:</label>
                        <select class="form-select" id="filterMonth" multiple size="3"></select>
                    </div>
                </div>
                <div class="row g-3 mt-3">
                    <div class="col-md-4">
                        <label class="form-label">Quinzena:</label>
                        <div id="filterQuinzena">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="quinzena1" value="Primeira" checked>
                                <label class="form-check-label" for="quinzena1">Primeira</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="quinzena2" value="Segunda" checked>
                                <label class="form-check-label" for="quinzena2">Segunda</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Dia da Semana:</label>
                        <div id="filterDiaSemana">
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="diaSeg" value="Seg" checked><label class="form-check-label" for="diaSeg">Seg</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="diaTer" value="Ter" checked><label class="form-check-label" for="diaTer">Ter</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="diaQua" value="Qua" checked><label class="form-check-label" for="diaQua">Qua</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="diaQui" value="Qui" checked><label class="form-check-label" for="diaQui">Qui</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="diaSex" value="Sex" checked><label class="form-check-label" for="diaSex">Sex</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="diaSab" value="Sab" checked><label class="form-check-label" for="diaSab">Sab</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="diaDom" value="Dom" checked><label class="form-check-label" for="diaDom">Dom</label></div>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mt-3">
                    <div class="col-md-6">
                        <label class="form-label">Serviço:</label>
                        <div id="filterServico">
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="servCabelo" value="CABELO" checked><label class="form-check-label" for="servCabelo">CABELO</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="servBarba" value="BARBA" checked><label class="form-check-label" for="servBarba">BARBA</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="servCombo" value="COMBO CABELO+BARBA" checked><label class="form-check-label" for="servCombo">COMBO</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="servSobrancelha" value="SOBRANCELHA" checked><label class="form-check-label" for="servSobrancelha">SOBRANCELHA</label></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Forma de Pagamento:</label>
                        <div id="filterPagto">
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="pagPix" value="PIX" checked><label class="form-check-label" for="pagPix">PIX</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="pagCredito" value="CRÉDITO" checked><label class="form-check-label" for="pagCredito">CRÉDITO</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="pagDebito" value="DÉBITO" checked><label class="form-check-label" for="pagDebito">DÉBITO</label></div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <button class="btn btn-primary w-100" id="applyFiltersBtn">Aplicar Filtros</button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-danger w-100" id="clearFiltersBtn">Limpar Filtros</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graphs Section -->
        <div class="card mb-4">
            <div class="card-header">Gráficos de Análise</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <canvas id="chartFaturamentoClientesMensal"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <canvas id="chartReceitaServico"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <canvas id="chartQuantidadeServicos"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <canvas id="chartReceitaPagamento"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <canvas id="chartFaturamentoDiaSemana"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <canvas id="chartClientesMeta"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <canvas id="chartComissao"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="chart-container">
                            <canvas id="chartEvolucaoPagamentos"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Table Section -->
        <div class="card mb-4">
            <div class="card-header">Resumo Mensal</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Mês/Ano</th>
                                <th>Faturamento</th>
                                <th>Clientes</th>
                                <th>Ticket Médio</th>
                                <th>Meta Faturamento</th>
                                <th>% Atingida</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                            <tr><td colspan="6" class="text-center">Importe e execute a análise para ver os dados.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Reino da Barba. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- SheetJS (xlsx.js) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- Moment.js (for date handling with Chart.js) -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/locale/pt-br.js"></script>
    <!-- FileSaver.js (for saving files) -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
        // Register Chart.js Data Labels Plugin globally
        Chart.register(ChartDataLabels);
        moment.locale('pt-br');

        let rawData = [];
        let processedData = [];
        let filteredData = [];
        let metaData = {}; // Stores meta_mensal and meta_clientes per month/year
        let charts = {}; // Object to hold Chart.js instances

        const requiredColumns = [
            'ano', 'mes', 'dia', 'dia_semana', 'quinzenas', 'cliente', 'servico', 'valor',
            'pagto', 'comissao_jean', 'comissao_reino_da_barba', 'meta_mensal', 'meta_clientes'
        ];

        const monthNames = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
        const monthNameToIndex = {
            "JAN": 0, "FEV": 1, "MAR": 2, "ABR": 3, "MAI": 4, "JUN": 5,
            "JUL": 6, "AGO": 7, "SET": 8, "OUT": 9, "NOV": 10, "DEZ": 11
        };
        const diaSemanaNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"];

        // --- Helper Functions ---
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatPercentage(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value / 100);
        }

        function showMessage(type, message) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                        ${message}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>`;
        }

        function getMonthName(monthIndex) {
            return monthNames[monthIndex];
        }

        function getMonthIndex(monthName) {
            return monthNameToIndex[monthName.toUpperCase()];
        }

        // --- Data Processing ---
        function validateAndProcessData(jsonData) {
            if (!jsonData || jsonData.length === 0) {
                showMessage('danger', 'O arquivo Excel está vazio ou não contém dados.');
                document.getElementById('executeAnalysisBtn').classList.add('d-none');
                return false;
            }

            const firstRow = jsonData[0];
            const missingCols = requiredColumns.filter(col => !Object.keys(firstRow).includes(col));

            if (missingCols.length > 0) {
                showMessage('danger', `Colunas obrigatórias faltando: ${missingCols.join(', ')}. Verifique seu arquivo Excel.`);
                document.getElementById('executeAnalysisBtn').classList.add('d-none');
                return false;
            }

            processedData = jsonData.map(row => {
                const mesIndex = typeof row.mes === 'string' ? getMonthIndex(row.mes) : (row.mes - 1); // Convert JAN to 0, FEV to 1, etc. or 1-indexed number to 0-indexed
                const date = moment({ year: row.ano, month: mesIndex, day: row.dia });

                return {
                    ...row,
                    valor: parseFloat(String(row.valor).replace(',', '.')) || 0,
                    comissao_jean: parseFloat(String(row.comissao_jean).replace(',', '.')) || 0,
                    comissao_reino_da_barba: parseFloat(String(row.comissao_reino_da_barba).replace(',', '.')) || 0,
                    meta_mensal: parseFloat(String(row.meta_mensal).replace(',', '.')) || 0,
                    meta_clientes: parseInt(row.meta_clientes) || 0,
                    date: date.isValid() ? date.toDate() : null, // Store as Date object
                    mes_num: mesIndex, // Store 0-indexed month number
                    dia_semana_num: date.isValid() ? date.day() : null // 0 for Sunday, 1 for Monday
                };
            }).filter(row => row.date !== null); // Filter out rows with invalid dates

            // Populate metaData lookup table
            metaData = {};
            processedData.forEach(row => {
                const key = `${row.ano}-${row.mes_num}`;
                if (!metaData[key]) {
                    metaData[key] = {
                        meta_mensal: row.meta_mensal,
                        meta_clientes: row.meta_clientes
                    };
                }
            });

            showMessage('success', 'Dados do Excel importados e validados com sucesso! Clique em "Executar Análise" para ver o dashboard.');
            document.getElementById('executeAnalysisBtn').classList.remove('d-none');
            return true;
        }

        // --- Event Handlers ---
        document.getElementById('importExcelBtn').addEventListener('click', () => {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('warning', 'Por favor, selecione um arquivo Excel primeiro.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                rawData = jsonData; // Store raw data for backup
                validateAndProcessData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('executeAnalysisBtn').addEventListener('click', () => {
            if (processedData.length === 0) {
                showMessage('danger', 'Nenhum dado processado. Por favor, importe um arquivo Excel válido primeiro.');
                return;
            }
            document.getElementById('executeAnalysisBtn').classList.add('d-none');
            populateFilters();
            applyFilters();
            showMessage('success', 'Análise executada com sucesso!');
        });

        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

        // --- Filter Management ---
        function populateFilters() {
            const years = [...new Set(processedData.map(d => d.ano))].sort((a, b) => a - b);
            const months = [...new Set(processedData.map(d => d.mes_num))].sort((a, b) => a - b);
            const services = [...new Set(processedData.map(d => d.servico))];
            const pagtos = [...new Set(processedData.map(d => d.pagto))];

            const filterYearSelect = document.getElementById('filterYear');
            filterYearSelect.innerHTML = '';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.selected = true; // Select all by default
                filterYearSelect.appendChild(option);
            });

            const filterMonthSelect = document.getElementById('filterMonth');
            filterMonthSelect.innerHTML = '';
            months.forEach(monthIndex => {
                const option = document.createElement('option');
                option.value = monthIndex;
                option.textContent = getMonthName(monthIndex);
                option.selected = true; // Select all by default
                filterMonthSelect.appendChild(option);
            });

            // Set min/max dates for date pickers
            const allDates = processedData.map(d => d.date);
            const minDate = moment.min(allDates).format('YYYY-MM-DD');
            const maxDate = moment.max(allDates).format('YYYY-MM-DD');
            document.getElementById('filterStartDate').value = minDate;
            document.getElementById('filterEndDate').value = maxDate;

            // Ensure all checkboxes are checked by default
            document.querySelectorAll('#filterQuinzena input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.querySelectorAll('#filterDiaSemana input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.querySelectorAll('#filterServico input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.querySelectorAll('#filterPagto input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function getSelectedValues(id) {
            const select = document.getElementById(id);
            return Array.from(select.options).filter(option => option.selected).map(option => option.value);
        }

        function getCheckedValues(id) {
            return Array.from(document.querySelectorAll(`#${id} input[type="checkbox"]:checked`)).map(cb => cb.value);
        }

        function applyFilters() {
            if (processedData.length === 0) {
                showMessage('warning', 'Nenhum dado para filtrar. Por favor, importe um arquivo Excel primeiro.');
                return;
            }

            const startDate = moment(document.getElementById('filterStartDate').value);
            const endDate = moment(document.getElementById('filterEndDate').value);
            const selectedYears = getSelectedValues('filterYear').map(Number);
            const selectedMonths = getSelectedValues('filterMonth').map(Number);
            const selectedQuinzenas = getCheckedValues('filterQuinzena');
            const selectedDiasSemana = getCheckedValues('filterDiaSemana');
            const selectedServicos = getCheckedValues('filterServico');
            const selectedPagtos = getCheckedValues('filterPagto');

            filteredData = processedData.filter(row => {
                const rowDate = moment(row.date);
                return rowDate.isBetween(startDate, endDate, null, '[]') && // Inclusive start and end
                       selectedYears.includes(row.ano) &&
                       selectedMonths.includes(row.mes_num) &&
                       selectedQuinzenas.includes(row.quinzenas) &&
                       selectedDiasSemana.includes(row.dia_semana) &&
                       selectedServicos.includes(row.servico) &&
                       selectedPagtos.includes(row.pagto);
            });

            updateKPIs();
            updateCharts();
            updateSummaryTable();
        }

        function clearFilters() {
            // Reset date pickers to min/max of processedData
            const allDates = processedData.map(d => d.date);
            if (allDates.length > 0) {
                document.getElementById('filterStartDate').value = moment.min(allDates).format('YYYY-MM-DD');
                document.getElementById('filterEndDate').value = moment.max(allDates).format('YYYY-MM-DD');
            } else {
                document.getElementById('filterStartDate').value = '';
                document.getElementById('filterEndDate').value = '';
            }

            // Select all options in dropdowns
            document.querySelectorAll('#filterYear option').forEach(option => option.selected = true);
            document.querySelectorAll('#filterMonth option').forEach(option => option.selected = true);

            // Check all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);

            applyFilters();
        }

        // --- KPI Updates ---
        function updateKPIs() {
            const totalFaturamento = filteredData.reduce((sum, row) => sum + row.valor, 0);
            const totalClientes = new Set(filteredData.map(row => row.cliente)).size;
            const totalAtendimentos = filteredData.length;
            const ticketMedio = totalAtendimentos > 0 ? totalFaturamento / totalAtendimentos : 0;
            const comissaoJean = filteredData.reduce((sum, row) => sum + row.comissao_jean, 0);
            const comissaoReino = filteredData.reduce((sum, row) => sum + row.comissao_reino_da_barba, 0);

            // For Meta Atingida and Taxa de Conversão, sum metas from the filtered months
            let totalMetaFaturamento = 0;
            let totalMetaClientes = 0;
            const uniqueMonthsInFilteredData = [...new Set(filteredData.map(d => `${d.ano}-${d.mes_num}`))];
            uniqueMonthsInFilteredData.forEach(monthKey => {
                if (metaData[monthKey]) {
                    totalMetaFaturamento += metaData[monthKey].meta_mensal;
                    totalMetaClientes += metaData[monthKey].meta_clientes;
                }
            });

            const metaAtingida = totalMetaFaturamento > 0 ? (totalFaturamento / totalMetaFaturamento) * 100 : 0;
            const taxaConversao = totalMetaClientes > 0 ? (totalClientes / totalMetaClientes) * 100 : 0;

            // Crescimento Mês a Mês
            let crescimentoMesAMes = 0;
            if (filteredData.length > 0) {
                const monthlyData = {};
                filteredData.forEach(row => {
                    const monthYear = moment(row.date).format('YYYY-MM');
                    monthlyData[monthYear] = (monthlyData[monthYear] || 0) + row.valor;
                });
                const sortedMonths = Object.keys(monthlyData).sort();
                if (sortedMonths.length >= 2) {
                    const currentMonthValue = monthlyData[sortedMonths[sortedMonths.length - 1]];
                    const previousMonthValue = monthlyData[sortedMonths[sortedMonths.length - 2]];
                    if (previousMonthValue > 0) {
                        crescimentoMesAMes = ((currentMonthValue - previousMonthValue) / previousMonthValue) * 100;
                    }
                }
            }


            document.getElementById('kpiFaturamentoTotal').textContent = formatCurrency(totalFaturamento);
            document.getElementById('kpiTotalClientes').textContent = totalClientes;
            document.getElementById('kpiTicketMedio').textContent = formatCurrency(ticketMedio);
            document.getElementById('kpiCrescimentoMes').textContent = formatPercentage(crescimentoMesAMes);
            document.getElementById('kpiComissaoJean').textContent = formatCurrency(comissaoJean);
            document.getElementById('kpiComissaoReino').textContent = formatCurrency(comissaoReino);
            document.getElementById('kpiMetaAtingida').textContent = formatPercentage(metaAtingida);
            document.getElementById('kpiTaxaConversao').textContent = formatPercentage(taxaConversao);
        }

        // --- Chart Updates ---
        function destroyCharts() {
            for (const chartId in charts) {
                if (charts[chartId]) {
                    charts[chartId].destroy();
                    charts[chartId] = null;
                }
            }
        }

        function updateCharts() {
            destroyCharts(); // Destroy existing charts before creating new ones

            // Chart 1: Faturamento e Clientes Mensal
            const monthlyAgg = {};
            filteredData.forEach(row => {
                const monthYear = moment(row.date).format('YYYY-MM');
                if (!monthlyAgg[monthYear]) {
                    monthlyAgg[monthYear] = { faturamento: 0, clientes: new Set() };
                }
                monthlyAgg[monthYear].faturamento += row.valor;
                monthlyAgg[monthYear].clientes.add(row.cliente);
            });
            const sortedMonths = Object.keys(monthlyAgg).sort();
            const labels1 = sortedMonths.map(my => moment(my).format('MMM/YY'));
            const faturamentoData = sortedMonths.map(my => monthlyAgg[my].faturamento);
            const clientesData = sortedMonths.map(my => monthlyAgg[my].clientes.size);

            const ctx1 = document.getElementById('chartFaturamentoClientesMensal').getContext('2d');
            charts.chartFaturamentoClientesMensal = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels1,
                    datasets: [
                        {
                            label: 'Faturamento (R$)',
                            data: faturamentoData,
                            backgroundColor: 'rgba(212, 175, 55, 0.8)', // Golden
                            borderColor: 'rgba(212, 175, 55, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Clientes',
                            data: clientesData,
                            type: 'line',
                            borderColor: 'rgba(248, 249, 250, 0.8)', // White
                            backgroundColor: 'rgba(248, 249, 250, 0.2)',
                            fill: true,
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Faturamento e Clientes Mensal', color: 'var(--text-color)' },
                        legend: { labels: { color: 'var(--text-color)' } },
                        datalabels: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: 'var(--text-color)' }, grid: { color: 'var(--border-color)' } },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: 'var(--text-color)', callback: function(value) { return formatCurrency(value); } },
                            grid: { color: 'var(--border-color)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: 'var(--text-color)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });

            // Chart 2: Receita por Tipo de Serviço (Pizza)
            const servicoAgg = {};
            filteredData.forEach(row => {
                servicoAgg[row.servico] = (servicoAgg[row.servico] || 0) + row.valor;
            });
            const labels2 = Object.keys(servicoAgg);
            const data2 = Object.values(servicoAgg);
            const backgroundColors2 = ['#d4af37', '#8b4513', '#a0522d', '#cd853f']; // Golden, SaddleBrown, Sienna, Peru

            const ctx2 = document.getElementById('chartReceitaServico').getContext('2d');
            charts.chartReceitaServico = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: labels2,
                    datasets: [{
                        data: data2,
                        backgroundColor: backgroundColors2,
                        borderColor: var('--secondary-bg'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Receita por Tipo de Serviço', color: 'var(--text-color)' },
                        legend: { position: 'right', labels: { color: 'var(--text-color)' } },
                        datalabels: {
                            color: '#fff',
                            formatter: (value, ctx) => {
                                let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(2) + '%';
                                return percentage;
                            }
                        }
                    }
                }
            });

            // Chart 3: Quantidade de Serviços (Coluna)
            const servicoCountAgg = {};
            filteredData.forEach(row => {
                servicoCountAgg[row.servico] = (servicoCountAgg[row.servico] || 0) + 1;
            });
            const labels3 = Object.keys(servicoCountAgg);
            const data3 = Object.values(servicoCountAgg);

            const ctx3 = document.getElementById('chartQuantidadeServicos').getContext('2d');
            charts.chartQuantidadeServicos = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: labels3,
                    datasets: [{
                        label: 'Quantidade de Serviços',
                        data: data3,
                        backgroundColor: 'rgba(212, 175, 55, 0.8)',
                        borderColor: 'rgba(212, 175, 55, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Quantidade de Serviços', color: 'var(--text-color)' },
                        legend: { display: false },
                        datalabels: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: 'var(--text-color)' }, grid: { color: 'var(--border-color)' } },
                        y: { ticks: { color: 'var(--text-color)' }, grid: { color: 'var(--border-color)' } }
                    }
                }
            });

            // Chart 4: Receita por Forma de Pagamento (Pizza)
            const pagtoAgg = {};
            filteredData.forEach(row => {
                pagtoAgg[row.pagto] = (pagtoAgg[row.pagto] || 0) + row.valor;
            });
            const labels4 = Object.keys(pagtoAgg);
            const data4 = Object.values(pagtoAgg);
            const backgroundColors4 = ['#d4af37', '#f8f9fa', '#6c757d']; // Golden, White, Gray

            const ctx4 = document.getElementById('chartReceitaPagamento').getContext('2d');
            charts.chartReceitaPagamento = new Chart(ctx4, {
                type: 'pie',
                data: {
                    labels: labels4,
                    datasets: [{
                        data: data4,
                        backgroundColor: backgroundColors4,
                        borderColor: var('--secondary-bg'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Receita por Forma de Pagamento', color: 'var(--text-color)' },
                        legend: { position: 'right', labels: { color: 'var(--text-color)' } },
                        datalabels: {
                            color: '#fff',
                            formatter: (value, ctx) => {
                                let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(2) + '%';
                                return percentage;
                            }
                        }
                    }
                }
            });

            // Chart 5: Faturamento por Dia da Semana (Coluna)
            const diaSemanaAgg = {};
            filteredData.forEach(row => {
                const dayName = diaSemanaNames[row.dia_semana_num];
                diaSemanaAgg[dayName] = (diaSemanaAgg[dayName] || 0) + row.valor;
            });
            const labels5 = diaSemanaNames.filter(day => Object.keys(diaSemanaAgg).includes(day)); // Ensure order
            const data5 = labels5.map(day => diaSemanaAgg[day]);

            const ctx5 = document.getElementById('chartFaturamentoDiaSemana').getContext('2d');
            charts.chartFaturamentoDiaSemana = new Chart(ctx5, {
                type: 'bar',
                data: {
                    labels: labels5,
                    datasets: [{
                        label: 'Faturamento (R$)',
                        data: data5,
                        backgroundColor: 'rgba(212, 175, 55, 0.8)',
                        borderColor: 'rgba(212, 175, 55, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Faturamento por Dia da Semana', color: 'var(--text-color)' },
                        legend: { display: false },
                        datalabels: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: 'var(--text-color)' }, grid: { color: 'var(--border-color)' } },
                        y: { ticks: { color: 'var(--text-color)', callback: function(value) { return formatCurrency(value); } }, grid: { color: 'var(--border-color)' } }
                    }
                }
            });

            // Chart 6: Clientes vs Meta (Coluna + Linha)
            const monthlyClientsAgg = {};
            filteredData.forEach(row => {
                const monthYear = moment(row.date).format('YYYY-MM');
                if (!monthlyClientsAgg[monthYear]) {
                    monthlyClientsAgg[monthYear] = { clientes: new Set(), meta_clientes: 0 };
                }
                monthlyClientsAgg[monthYear].clientes.add(row.cliente);
                // Get meta from metaData lookup
                const metaKey = `${row.ano}-${row.mes_num}`;
                if (metaData[metaKey]) {
                    monthlyClientsAgg[monthYear].meta_clientes = metaData[metaKey].meta_clientes;
                }
            });
            const sortedMonths6 = Object.keys(monthlyClientsAgg).sort();
            const labels6 = sortedMonths6.map(my => moment(my).format('MMM/YY'));
            const clientesRealizados = sortedMonths6.map(my => monthlyClientsAgg[my].clientes.size);
            const clientesMeta = sortedMonths6.map(my => monthlyClientsAgg[my].meta_clientes);

            const ctx6 = document.getElementById('chartClientesMeta').getContext('2d');
            charts.chartClientesMeta = new Chart(ctx6, {
                type: 'bar',
                data: {
                    labels: labels6,
                    datasets: [
                        {
                            label: 'Clientes Realizados',
                            data: clientesRealizados,
                            backgroundColor: 'rgba(212, 175, 55, 0.8)',
                            borderColor: 'rgba(212, 175, 55, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Meta de Clientes',
                            data: clientesMeta,
                            type: 'line',
                            borderColor: 'rgba(248, 249, 250, 0.8)',
                            backgroundColor: 'rgba(248, 249, 250, 0.2)',
                            fill: false,
                            yAxisID: 'y',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Clientes Realizados vs Meta Mensal', color: 'var(--text-color)' },
                        legend: { labels: { color: 'var(--text-color)' } },
                        datalabels: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: 'var(--text-color)' }, grid: { color: 'var(--border-color)' } },
                        y: { ticks: { color: 'var(--text-color)' }, grid: { color: 'var(--border-color)' } }
                    }
                }
            });

            // Chart 7: Comissão Jean vs Salão (Coluna)
            const comissaoAgg = {};
            filteredData.forEach(row => {
                const monthYear = moment(row.date).format('YYYY-MM');
                if (!comissaoAgg[monthYear]) {
                    comissaoAgg[monthYear] = { jean: 0, reino: 0 };
                }
                comissaoAgg[monthYear].jean += row.comissao_jean;
                comissaoAgg[monthYear].reino += row.comissao_reino_da_barba;
            });
            const sortedMonths7 = Object.keys(comissaoAgg).sort();
            const labels7 = sortedMonths7.map(my => moment(my).format('MMM/YY'));
            const comissaoJeanData = sortedMonths7.map(my => comissaoAgg[my].jean);
            const comissaoReinoData = sortedMonths7.map(my => comissaoAgg[my].reino);

            const ctx7 = document.getElementById('chartComissao').getContext('2d');
            charts.chartComissao = new Chart(ctx7, {
                type: 'bar',
                data: {
                    labels: labels7,
                    datasets: [
                        {
                            label: 'Comissão Jean (R$)',
                            data: comissaoJeanData,
                            backgroundColor: 'rgba(212, 175, 55, 0.8)',
                            borderColor: 'rgba(212, 175, 55, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Comissão Salão (R$)',
                            data: comissaoReinoData,
                            backgroundColor: 'rgba(248, 249, 250, 0.8)',
                            borderColor: 'rgba(248, 249, 250, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Comissão Jean vs Salão Mensal', color: 'var(--text-color)' },
                        legend: { labels: { color: 'var(--text-color)' } },
                        datalabels: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: 'var(--text-color)' }, grid: { color: 'var(--border-color)' } },
                        y: { ticks: { color: 'var(--text-color)', callback: function(value) { return formatCurrency(value); } }, grid: { color: 'var(--border-color)' } }
                    }
                }
            });

            // Chart 8: Evolução de Pagamentos (Coluna Empilhada)
            const pagtoMonthlyAgg = {};
            filteredData.forEach(row => {
                const monthYear = moment(row.date).format('YYYY-MM');
                if (!pagtoMonthlyAgg[monthYear]) {
                    pagtoMonthlyAgg[monthYear] = { PIX: 0, CRÉDITO: 0, DÉBITO: 0 };
                }
                pagtoMonthlyAgg[monthYear][row.pagto] = (pagtoMonthlyAgg[monthYear][row.pagto] || 0) + row.valor;
            });
            const sortedMonths8 = Object.keys(pagtoMonthlyAgg).sort();
            const labels8 = sortedMonths8.map(my => moment(my).format('MMM/YY'));
            const pixData = sortedMonths8.map(my => pagtoMonthlyAgg[my].PIX || 0);
            const creditoData = sortedMonths8.map(my => pagtoMonthlyAgg[my].CRÉDITO || 0);
            const debitoData = sortedMonths8.map(my => pagtoMonthlyAgg[my].DÉBITO || 0);

            const ctx8 = document.getElementById('chartEvolucaoPagamentos').getContext('2d');
            charts.chartEvolucaoPagamentos = new Chart(ctx8, {
                type: 'bar',
                data: {
                    labels: labels8,
                    datasets: [
                        {
                            label: 'PIX',
                            data: pixData,
                            backgroundColor: 'rgba(212, 175, 55, 0.8)',
                            borderColor: 'rgba(212, 175, 55, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'CRÉDITO',
                            data: creditoData,
                            backgroundColor: 'rgba(248, 249, 250, 0.8)',
                            borderColor: 'rgba(248, 249, 250, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'DÉBITO',
                            data: debitoData,
                            backgroundColor: 'rgba(108, 117, 125, 0.8)',
                            borderColor: 'rgba(108, 117, 125, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Evolução de Pagamentos Mensal', color: 'var(--text-color)' },
                        legend: { labels: { color: 'var(--text-color)' } },
                        datalabels: { display: false }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: 'var(--text-color)' }, grid: { color: 'var(--border-color)' } },
                        y: { stacked: true, ticks: { color: 'var(--text-color)', callback: function(value) { return formatCurrency(value); } }, grid: { color: 'var(--border-color)' } }
                    }
                }
            });
        }

        // --- Summary Table Update ---
        function updateSummaryTable() {
            const tableBody = document.getElementById('summaryTableBody');
            tableBody.innerHTML = '';

            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum dado para exibir com os filtros aplicados.</td></tr>';
                return;
            }

            const monthlyAgg = {};
            filteredData.forEach(row => {
                const monthYearKey = `${row.ano}-${row.mes_num}`;
                if (!monthlyAgg[monthYearKey]) {
                    monthlyAgg[monthYearKey] = {
                        faturamento: 0,
                        clientes: new Set(),
                        meta_mensal: 0,
                        meta_clientes: 0
                    };
                }
                monthlyAgg[monthYearKey].faturamento += row.valor;
                monthlyAgg[monthYearKey].clientes.add(row.cliente);

                // Get meta from metaData lookup
                if (metaData[monthYearKey]) {
                    monthlyAgg[monthYearKey].meta_mensal = metaData[monthYearKey].meta_mensal;
                    monthlyAgg[monthYearKey].meta_clientes = metaData[monthYearKey].meta_clientes;
                }
            });

            const sortedMonthKeys = Object.keys(monthlyAgg).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            sortedMonthKeys.forEach(key => {
                const data = monthlyAgg[key];
                const [year, monthNum] = key.split('-');
                const monthName = getMonthName(parseInt(monthNum));
                const faturamento = data.faturamento;
                const clientes = data.clientes.size;
                const ticketMedio = clientes > 0 ? faturamento / clientes : 0;
                const metaFaturamento = data.meta_mensal;
                const percentAtingida = metaFaturamento > 0 ? (faturamento / metaFaturamento) * 100 : 0;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${monthName}/${year}</td>
                    <td>${formatCurrency(faturamento)}</td>
                    <td>${clientes}</td>
                    <td>${formatCurrency(ticketMedio)}</td>
                    <td>${formatCurrency(metaFaturamento)}</td>
                    <td>${formatPercentage(percentAtingida)}</td>
                `;
            });
        }

        // --- Export Functions ---
        function exportData(format) {
            if (filteredData.length === 0) {
                showMessage('warning', 'Nenhum dado para exportar. Aplique os filtros primeiro.');
                return;
            }

            const filename = `reino_da_barba_dashboard_export_${moment().format('YYYYMMDD_HHmmss')}`;
            let dataToExport = filteredData.map(row => {
                // Create a clean object for export, removing internal 'date', 'mes_num', 'dia_semana_num'
                const { date, mes_num, dia_semana_num, ...rest } = row;
                return rest;
            });

            if (format === 'csv') {
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const csv = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, `${filename}.csv`);
            } else if (format === 'json') {
                const json = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
                saveAs(blob, `${filename}.json`);
            }
        }

        function downloadBackup() {
            if (rawData.length === 0) {
                showMessage('warning', 'Nenhum dado bruto para backup. Importe um arquivo Excel primeiro.');
                return;
            }
            const filename = `reino_da_barba_backup_raw_data_${moment().format('YYYYMMDD_HHmmss')}.json`;
            const json = JSON.stringify(rawData, null, 2);
            const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
            saveAs(blob, filename);
        }

        document.getElementById('exportCsvBtn').addEventListener('click', () => exportData('csv'));
        document.getElementById('exportJsonBtn').addEventListener('click', () => exportData('json'));
        document.getElementById('downloadBackupBtn').addEventListener('click', downloadBackup);

        // Initial state: disable buttons and show placeholder
        document.addEventListener('DOMContentLoaded', () => {
            updateKPIs(); // Show 0s initially
            updateCharts(); // Show empty charts
            updateSummaryTable(); // Show placeholder
        });

    </script>
</body>
</html>
